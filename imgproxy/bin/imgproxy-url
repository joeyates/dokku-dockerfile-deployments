#!/usr/bin/env iex

# bin/imgproxy-url --prefix "https://$APP_DOMAIN" --key "$IMGPROXY_KEY" --salt "$IMGPROXY_SALT" --url "local:///path/to/image.jpg"

Mix.install([
  {:helpful_options, "~> 0.3"},
  {:imgproxy, "~> 3.1",
   git: "https://github.com/bmuller/imgproxy.git",
   ref: "b181f2932b2f7f2448a3ff873d9b2b105d9a32ba"}
])

options_switches = [
  url: %{type: :string, required: true},
  prefix: %{type: :string, required: true},
  key: %{type: :string},
  salt: %{type: :string}
]

{url, options} =
  case HelpfulOptions.parse(System.argv(), switches: options_switches) do
    {:ok, parsed, []} ->
      Map.pop(parsed, :url)

    {:error, reason} ->
      raise "Error: #{reason}"
  end

Application.put_env(:imgproxy, :prefix, options.prefix)
if options[:key] && options[:salt] do
  Application.put_env(:imgproxy, :key, options.key)
  Application.put_env(:imgproxy, :salt, options.salt)
end

img =
  url
  |> Imgproxy.new()
  |> Imgproxy.set_source_url_encoding(:plain)

IO.puts Imgproxy.to_string(img)

System.halt()
