#!/usr/bin/env node

const key = process.env.IMGPROXY_KEY
const salt = process.env.IMGPROXY_SALT
const baseURL = process.argv[2]
// path should be '/plain/local:///IMAGE_NAME.EXT'
const path = process.argv[3]

const createHmac = require('crypto').createHmac

const hexDecode = hex => Buffer.from(hex, 'hex')

const sign = ({salt, path, key}) => {
  const hmac = createHmac('sha256', hexDecode(key))
  hmac.update(hexDecode(salt))
  hmac.update(path)

  return hmac.digest('base64url')
}

const signature = sign({salt, path, key})
const url = `${baseURL}/${signature}${path}`
console.log(url)
